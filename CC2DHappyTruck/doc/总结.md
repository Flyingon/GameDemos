# 🚚 画线卡车小游戏开发记｜两大物理难点的攻克

> 在线试玩：`https://www.guaguatu.com/public/web-mobile/`

大家好，这是一款用 Cocos Creator 打造的 2D 物理小游戏 Demo：在屏幕上画线，生成可碰撞的桥面，让卡车通过。项目的代码最初由 AI 生成，后来我们针对体验做了两轮打磨（记录见 `doc/cursor_record/`）。本文聚焦两个印象最深的技术难点，并总结可落地的解决方案与调参心法。

---

## 🧭 目录
- 难点一｜让“刚体线条”既平滑又可物理交互
- 难点二｜轮胎与车身比例、重心与扭矩摩擦的平衡
- 玩法与流程速览
- 核心代码位置索引
- 结语

---

## 🔧 难点一：让“刚体线条”既平滑又可物理交互

**痛点描述**
- 直接用 `Graphics` 绘制的线条只负责渲染，不参与物理；要让卡车“走在画出来的线”上，必须把轨迹点转化为一系列可碰撞的刚体形状。
- 如果处理不当，会出现台阶感、段与段之间缝隙，甚至小车从缝里掉下去。

**方案演进**
- 多边形薄片段拼接（早期方案）
  - 把每段轨迹点转为一片薄的 `PolygonCollider2D`，在 `y` 方向加一点厚度，逐段拼接为桥。
  - 代码位置：`assets/script/game/DrawBridge.ts:67-124`
- 盒体旋转对齐（稳定方案）
  - 每一段计算中心点与角度，用旋转后的 `BoxCollider2D` 表示线段，统一厚度与朝向，减少台阶与缝隙。
  - 代码位置：`assets/script/game/DrawBridgeV2.ts:64-115`

**实现要点**
- 点合并阈值：近距离点合并，减少微段与锯齿（`segmentLength`，如 20；`assets/script/game/DrawBridgeV2.ts:15`）。
- 线段厚度：给线加“物理厚度”，避免轮子穿透（`colliderThickness`，如 5；`assets/script/game/DrawBridgeV2.ts:16`）。
- 可视化调试：打开 2D 物理调试绘制，直观看到碰撞形状与关节（`assets/script/game/DrawBridgeV2.ts:19-23`）。
- 生命周期管理：重开游戏时清除旧桥段，防止历史段干扰（`assets/script/game/GameController.ts:32-37`）。

**开发心法**
- 画的是视觉，走的是物理：所有可碰撞线段都需要对应的 Collider。
- 少而稳的段：合并短段，统一厚度与方向，避免微台阶。
- 随时看得到：打开 Debug Draw，校验每次生成的物理形状。

---

## 📝 划线问题复盘：问题与方案

**遇到的问题**
- 坐标系不一致：绘制采样用屏幕坐标，`Graphics`/Collider 用本地坐标，导致线与桥错位（`assets/script/game/DrawBridgeV2.ts:59-62`）。
- 线条不可碰撞：`PolygonCollider2D` 需要封闭形状，直接折线无法参与物理；零厚度边缘接触不稳。
- 视觉与物理厚度不一致：玩家画线很细，桥段太厚，观感不匹配（`assets/script/game/DrawBridgeV2.ts:15-16,29,93-95,101-104`）。
- 段过密导致“台阶”：采样点过密造成碎段，轮胎在段缝处抖动或卡住（`assets/script/game/DrawBridgeV2.ts:15,40-47,76-79`）。
- 桥段生命周期：重开未清除旧桥，历史节点残留影响后续行为（`assets/script/game/DrawBridge.ts:129-135`；`assets/script/game/GameController.ts:32-37`）。

**采用的解决方案**
- 坐标转换到本地空间：将触点从屏幕坐标转换为当前节点本地坐标，保证绘制与碰撞一致（`assets/script/game/DrawBridgeV2.ts:59-62`，`assets/script/game/DrawBridge.ts:62-65`）。
- 生成“有厚度”的可碰撞桥段：
  - 贴线薄多边形：沿手绘线在 Y 方向上下各扩展，形成窄矩形多边形段（`assets/script/game/DrawBridge.ts:67-124,93-101,102`）。
  - 旋转盒体对齐：按线段中心与角度放置旋转 `BoxCollider2D`，统一厚度与方向，更稳定（`assets/script/game/DrawBridgeV2.ts:81-85,87-90,91-95,97-99`）。
- 统一视觉与物理厚度：设置 `graphics.lineWidth` 与桥段厚度一致，避免“细线粗桥”（`assets/script/game/DrawBridgeV2.ts:15-16,29,93-95,101-104`）。
- 合并短段减少台阶：通过 `segmentLength` 跳过过近采样点，使线段更长更平滑（`assets/script/game/DrawBridgeV2.ts:15,76-79`）。
- 清理桥段：重开时销毁所有桥段节点，保持场景干净（`assets/script/game/DrawBridge.ts:129-135`，控制器清桥 `assets/script/game/GameController.ts:32-37`）。
- 可视化调试：开启 2D 物理调试绘制，直观看到碰撞形状与关节，快速校验（`assets/script/game/DrawBridgeV2.ts:18-23`）。

**为何不用“线形”碰撞体**
- Cocos 2D 物理支持链/边缘线形，但零厚度更易出现高速穿透与断续接触。对“玩家自由绘制的动态桥”，统一厚度的盒体/薄多边形段更稳，更易调参与对齐。

**实现路径回顾**
- 触摸采集 → `Graphics` 预览 → 松手生成静态刚体段（`RigidBody2D`，`ERigidBody2DType.Static`）与 Collider → 将段加入场景（`assets/script/game/DrawBridgeV2.ts:64-115,109`）。

## 🚗 难点二：轮胎与车身比例、重心与扭矩摩擦的平衡

**痛点描述**
- 早期经常出现“轮子弹出车体/整车弹飞”的不稳定现象。根因在于质量分配方式、关节锚点、碰撞体重叠、扭矩与摩擦的不匹配，以及速度直接跃迁导致的物理爆冲。

**关键修正**
- 用密度控制质量，并调用 `apply()` 生效（`assets/script/game/Truck.ts:28-46`）
  - 在车体 Collider 设置 `density ≈ 1.5`，随后 `apply()`。
- 关节锚点精准对齐轮心（`assets/res/prefab/car.prefab:492-507,732-747`）
  - 后轮 `connectedAnchor = (-26,-26)`；前轮 `connectedAnchor = (26,-26)`。
- 摩擦与扭矩协同（`assets/script/game/Truck.ts:67-74`）
  - 增加轮胎摩擦（如 `≈ 2`）与马达最大扭矩（如 `≈ 1500-20000`），改善上坡与打滑。
- 速度用“加速度 + 上限”，避免瞬时爆冲（`assets/script/game/Truck.ts:24-26,126-134`）
  - 逐步把 `motorSpeed` 提升到 `maxSpeed`，提升稳定性与可控性。
- 正确认知 `WheelJoint2D.motorSpeed` 单位（详见 `doc/cursor_record/cursor_fixed_v2.md:886-906`）
  - 它是角速度（度/秒），不是线速度；数值过大叠加低摩擦/高扭矩更容易“爆炸”。

**推荐安全参数（按体验微调）**
- 轮胎摩擦：`≈ 2`
- 车体密度：`≈ 1.5`
- 最大扭矩：`≈ 1500-20000`
- 角速度控制：以加速度缓升到上限（如 `maxSpeed = 40` 起步）
- 关节频率/阻尼：适度提高，减少颠簸（注释位见 `assets/script/game/Truck.ts:62-65`）

**调参心法**
- 先结构后参数：锚点准、无重叠，是稳定性的前提。
- 先摩擦后扭矩：摩擦不足再大的扭矩也会“空转”。
- 速度递增而非跃迁：用“加速度 + 上限”控制，避免瞬间爆冲。
- 轮胎尺寸别太小：半径过小对台阶更敏感，线速度波动剧烈。
- 物理步长下调：项目设置中适当减小 `fixedTimeStep`，提升稳定性（详见过程记录）。

---

## 🎮 玩法与流程速览
- 画线：Canvas 收集触点并绘制预览；抬手后按段生成物理桥段（`assets/script/game/DrawBridge.ts:32-60,67-124`）。
- 控制：点击开始触发车辆加速行驶；重开时清桥、销毁旧车、实例化新车（`assets/script/game/GameController.ts:28-55`）。
- 驱动：两个 `WheelJoint2D` 同步设定 `motorSpeed`，以加速度逐步提升到 `maxSpeed`（`assets/script/game/Truck.ts:80-83,126-134`）。

---

## 🗂️ 核心代码位置索引
- 画线与桥生成（多边形/盒体）：`assets/script/game/DrawBridge.ts:67-124`、`assets/script/game/DrawBridgeV2.ts:64-115`
- 物理调试可视化：`assets/script/game/DrawBridgeV2.ts:19-23`
- 清桥与重开：`assets/script/game/GameController.ts:32-37`
- 车辆摩擦与扭矩：`assets/script/game/Truck.ts:67-74`
- 车辆速度控制（加速度/上限）：`assets/script/game/Truck.ts:24-26,126-134`
- 车辆质量（密度与 apply）：`assets/script/game/Truck.ts:28-46`
- 车轮关节与锚点：`assets/res/prefab/car.prefab:492-507,732-747`

---

## ✅ 结语
AI 能快速搭起玩法雏形，但要获得顺滑的物理体验，依然需要“结构正确 + 参数平衡”。本文记录的两大难点与思路，旨在为后续优化提供可复用的路径：例如更软的悬架模型、更平滑的路面插值（Catmull–Rom/Bezier）、按坡度自适应扭矩等。欢迎在试玩链接中体验，并提出更多改进建议。